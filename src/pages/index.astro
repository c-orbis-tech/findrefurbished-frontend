---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Debug - Vind Refurbished">
  <main class="max-w-4xl mx-auto p-10">
    <h1 class="text-2xl font-bold mb-5">Zoekmachine Debug Mode</h1>
    <div id="searchbox" class="mb-5 border p-2"></div>
    <div id="hits"></div>
  </main>

  <div id="meili-data" 
       data-host={import.meta.env.PUBLIC_MEILI_HOST} 
       data-key={import.meta.env.PUBLIC_MEILI_SEARCH_KEY}>
  </div>
</Layout>

<script is:inline src="https://cdn.jsdelivr.net/npm/@meilisearch/instant-meilisearch/dist/instant-meilisearch.umd.min.js"></script>
<script is:inline src="https://cdn.jsdelivr.net/npm/instantsearch.js@4"></script>

<script is:inline>
    function testMeili() {
    const dataEl = document.getElementById('meili-data');
    
    // FIX 1: We forceren HTTPS
    const host = dataEl.dataset.host.replace('http://', 'https://');
    const key = dataEl.dataset.key;

    console.log("--- DEBUG START ---");
    console.log("Verbinden met:", host);

    if (typeof instantMeiliSearch === 'undefined') {
      console.error("ERROR: MeiliSearch bibliotheek niet geladen!");
      return;
    }

            // De kogelvrije manier om de adapter te initialiseren
    let meiliAdapter;
    try {
      const factory = (typeof instantMeiliSearch.instantMeiliSearch === 'function') 
        ? instantMeiliSearch.instantMeiliSearch 
        : instantMeiliSearch;
      
      meiliAdapter = factory(host, key);
      
      // Als de search methode nog steeds ontbreekt, proberen we hem handmatig te binden
      if (typeof meiliAdapter.search !== 'function' && meiliAdapter.instantMeiliSearch) {
          meiliAdapter = meiliAdapter.instantMeiliSearch;
      }
    } catch (e) {
      console.error("Adapter crash:", e);
      return;
    }

    console.log("Gevalideerde adapter:", meiliAdapter);

        // De kogelvrije wrapper die de search methode ALTIJD vindt
    const searchClient = {
      search(requests) {
        // Check alle mogelijke plekken waar de search functie kan zitten
        const searchFn = meiliAdapter.search || 
                         (meiliAdapter.instantMeiliSearch && meiliAdapter.instantMeiliSearch.search) ||
                         (typeof meiliAdapter === 'function' ? meiliAdapter : null);
        
        if (typeof searchFn !== 'function') {
          console.error("KRITIEKE FOUT: Geen search functie gevonden in de adapter!", meiliAdapter);
          return;
        }
        return searchFn(requests);
      },
      searchForFacetValues(requests) {
        const facetFn = meiliAdapter.searchForFacetValues || 
                        (meiliAdapter.instantMeiliSearch && meiliAdapter.instantMeiliSearch.searchForFacetValues);
        return typeof facetFn === 'function' ? facetFn(requests) : undefined;
      }
    };

    // Maak de search instance aan
    const search = instantsearch({
      indexName: 'products',
      searchClient: searchClient,
      future: { preserveSharedStateOnUnmount: true }
    });

    console.log("InstantSearch instance aangemaakt.");

    search.addWidgets([
      instantsearch.widgets.searchBox({ container: '#searchbox' }),
      instantsearch.widgets.hits({
        container: '#hits',
        templates: {
          item: (hit) => `<div>✅ Gevonden: ${hit.title_h1 || hit.title}</div>`,
          empty: '❌ Geen resultaten gevonden in de index "products".'
        }
      })
    ]);

    search.on('render', () => {
      const results = search.helper.lastResults;
      if (results) {
        console.log("Meilisearch resultaten:", results.nbHits);
      }
    });

    try {
      search.start();
      console.log("Zoekmachine gestart!");
    } catch (err) {
      console.error("Crash tijdens starten:", err);
    }
  }


  // Wacht even tot alles echt geladen is
  setTimeout(testMeili, 1000);
</script>
