---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Debug - Vind Refurbished">
  <main class="max-w-4xl mx-auto p-10">
    <h1 class="text-2xl font-bold mb-5">Zoekmachine Debug Mode</h1>
    <div id="searchbox" class="mb-5 border p-2"></div>
    <div id="hits"></div>
  </main>

  <div id="meili-data" 
       data-host={import.meta.env.PUBLIC_MEILI_HOST} 
       data-key={import.meta.env.PUBLIC_MEILI_SEARCH_KEY}>
  </div>
</Layout>

<script>
  import { instantMeiliSearch } from '@meilisearch/instant-meilisearch';
  import instantsearch from 'instantsearch.js';
  import { searchBox, hits } from 'instantsearch.js/es/widgets';

  function init() {
    const dataEl = document.getElementById('meili-data');
    if (!dataEl) return;

    const host = dataEl.dataset.host?.replace('http://', 'https://');
    const key = dataEl.dataset.key;
    if (!host || !key) return;

    // 1. Maak de client aan
    const client = instantMeiliSearch(host, key);

    // 2. DE KOGELVRIJE WRAPPER (Dit lost de n.search error op)
    const searchClient = {
      search(requests) {
        // We roepen de search methode direct aan op de client
        // Dit voorkomt dat InstantSearch de verbinding verliest
        return client.search(requests);
      },
      searchForFacetValues(requests) {
        return client.searchForFacetValues ? client.searchForFacetValues(requests) : undefined;
      }
    };

    // 3. Initialiseer InstantSearch met de handmatige wrapper
    const search = instantsearch({
      indexName: 'products',
      searchClient: searchClient,
      future: { preserveSharedStateOnUnmount: true }
    });

    search.addWidgets([
      searchBox({ container: '#searchbox', placeholder: 'Zoek op model...' }),
      hits({
        container: '#hits',
        templates: {
          item: (hit) => `
            <div class="p-4 border mb-2 bg-white rounded-xl shadow-sm flex justify-between items-center">
              <div><span class="text-green-600">✅</span> <strong>${hit.title_h1 || 'Product'}</strong></div>
              <div class="font-bold text-blue-600">€${hit.min_price}</div>
            </div>
          `,
          empty: '<div class="p-10 text-center text-gray-500">❌ Geen producten gevonden.</div>'
        }
      })
    ]);

    try {
      search.start();
      console.log("Zoekmachine draait stabiel!");
    } catch (err) {
      console.error("Fout bij starten:", err);
    }
  }

  // Wacht tot alles geladen is en gebruik een kleine vertraging
  window.addEventListener('load', () => {
    setTimeout(init, 300);
  });
  
  // Ook voor Astro transities
  document.addEventListener('astro:page-load', () => {
    setTimeout(init, 300);
  });
</script>
